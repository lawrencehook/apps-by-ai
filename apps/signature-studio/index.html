<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature Studio - AI Showcase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
        }

        header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        header p {
            color: #888;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #aaa;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .workspace {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .workspace {
                grid-template-columns: 1fr;
            }
        }

        .canvas-container {
            background: rgba(255, 255, 255, 0.02);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }

        .canvas-wrapper {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }

        .canvas-wrapper.transparent-bg {
            background: repeating-conic-gradient(#ccc 0% 25%, #fff 0% 50%) 50% / 20px 20px;
        }

        #signatureCanvas {
            cursor: crosshair;
            touch-action: none;
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9em;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
        }

        .control-group input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        .color-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .color-preset {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
        }

        .color-preset:hover {
            transform: scale(1.1);
        }

        .color-preset.active {
            border-color: #fff;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ddd;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: rgba(234, 84, 85, 0.2);
            color: #ea5455;
            border: 1px solid rgba(234, 84, 85, 0.3);
        }

        .btn-danger:hover {
            background: rgba(234, 84, 85, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* Document tab styles */
        .document-workspace {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            .document-workspace {
                grid-template-columns: 1fr;
            }
        }

        .document-preview {
            background: rgba(255, 255, 255, 0.02);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            min-height: 600px;
            position: relative;
        }

        .document-canvas-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 550px;
            background: #333;
            border-radius: 8px;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        #documentCanvas {
            max-width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .upload-zone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-zone svg {
            width: 60px;
            height: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .upload-zone p {
            color: #888;
            margin-bottom: 10px;
        }

        .upload-zone span {
            color: #667eea;
        }

        .signature-overlay {
            position: absolute;
            cursor: move;
            border: 2px dashed #667eea;
            padding: 5px;
            background: rgba(255, 255, 255, 0.9);
        }

        .signature-overlay img {
            display: block;
            max-width: 100%;
            pointer-events: none;
        }

        .signature-overlay .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            bottom: -6px;
            right: -6px;
            cursor: se-resize;
        }

        .signature-overlay .rotate-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #764ba2;
            border-radius: 50%;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            cursor: grab;
        }

        .signature-overlay .delete-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ea5455;
            border-radius: 50%;
            top: -10px;
            right: -10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #fff;
        }

        /* Typed signature */
        .typed-signature-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            margin-bottom: 15px;
        }

        .font-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .font-option {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .font-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .font-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .font-option span {
            font-size: 1.3em;
        }

        /* Saved signatures */
        .saved-signatures {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .saved-signature {
            background: #fff;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .saved-signature:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .saved-signature img {
            width: 100%;
            height: 80px;
            object-fit: contain;
        }

        .saved-signature .delete-saved {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ea5455;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .saved-signature:hover .delete-saved {
            opacity: 1;
        }

        /* Export options */
        .export-options {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .export-option select {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #667eea;
            text-decoration: none;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 100;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: #764ba2;
        }

        .info-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .section-title {
            font-size: 1.1em;
            color: #fff;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* PDF Page navigation */
        .page-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .page-nav button {
            padding: 8px 16px;
        }

        .page-info {
            color: #888;
        }
    </style>
</head>
<body>
    <a href="../../index.html" class="back-link">← Back to Gallery</a>

    <div class="container">
        <header>
            <h1>Signature Studio</h1>
            <p>Create, customize, and apply signatures to documents</p>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="draw">Draw Signature</button>
            <button class="tab-btn" data-tab="type">Type Signature</button>
            <button class="tab-btn" data-tab="document">Apply to Document</button>
            <button class="tab-btn" data-tab="saved">Saved Signatures</button>
        </div>

        <!-- Draw Signature Tab -->
        <div class="tab-content active" id="draw-tab">
            <div class="workspace">
                <div class="canvas-container">
                    <div class="canvas-wrapper transparent-bg">
                        <canvas id="signatureCanvas" width="700" height="300"></canvas>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" id="undoBtn">↶ Undo</button>
                        <button class="btn btn-secondary" id="redoBtn">↷ Redo</button>
                        <button class="btn btn-danger" id="clearBtn">Clear</button>
                        <button class="btn btn-primary" id="saveSignatureBtn">Save Signature</button>
                    </div>
                </div>
                <div class="controls-panel">
                    <h3 class="section-title">Drawing Options</h3>

                    <div class="control-group">
                        <label>Stroke Color</label>
                        <input type="color" id="strokeColor" value="#000000">
                        <div class="color-presets">
                            <div class="color-preset active" style="background: #000000" data-color="#000000"></div>
                            <div class="color-preset" style="background: #1a237e" data-color="#1a237e"></div>
                            <div class="color-preset" style="background: #0d47a1" data-color="#0d47a1"></div>
                            <div class="color-preset" style="background: #004d40" data-color="#004d40"></div>
                            <div class="color-preset" style="background: #4a148c" data-color="#4a148c"></div>
                            <div class="color-preset" style="background: #b71c1c" data-color="#b71c1c"></div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Stroke Width: <span id="strokeWidthValue">3</span>px</label>
                        <input type="range" id="strokeWidth" min="1" max="10" value="3">
                    </div>

                    <div class="control-group">
                        <label>Smoothing: <span id="smoothingValue">0.5</span></label>
                        <input type="range" id="smoothing" min="0" max="1" step="0.1" value="0.5">
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="pressureSensitive" checked>
                        <label for="pressureSensitive">Pressure sensitive (if supported)</label>
                    </div>

                    <h3 class="section-title" style="margin-top: 30px;">Export Options</h3>

                    <div class="export-options">
                        <div class="export-option">
                            <label>Size:</label>
                            <select id="exportSize">
                                <option value="1">Original</option>
                                <option value="2" selected>2x</option>
                                <option value="3">3x</option>
                                <option value="0.5">0.5x</option>
                            </select>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="transparentBg" checked>
                            <label for="transparentBg">Transparent background</label>
                        </div>
                        <button class="btn btn-primary" id="exportPngBtn" style="width: 100%;">
                            Export as PNG
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Type Signature Tab -->
        <div class="tab-content" id="type-tab">
            <div class="workspace">
                <div class="canvas-container">
                    <div class="canvas-wrapper transparent-bg">
                        <canvas id="typedCanvas" width="700" height="300"></canvas>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="saveTypedBtn">Save Signature</button>
                        <button class="btn btn-primary" id="exportTypedBtn">Export as PNG</button>
                    </div>
                </div>
                <div class="controls-panel">
                    <h3 class="section-title">Type Your Name</h3>

                    <input type="text" class="typed-signature-input" id="signatureName" placeholder="Your Name">

                    <div class="control-group">
                        <label>Choose Font Style</label>
                        <div class="font-selector">
                            <div class="font-option selected" data-font="'Brush Script MT', cursive">
                                <span style="font-family: 'Brush Script MT', cursive">Signature</span>
                            </div>
                            <div class="font-option" data-font="'Lucida Handwriting', cursive">
                                <span style="font-family: 'Lucida Handwriting', cursive">Signature</span>
                            </div>
                            <div class="font-option" data-font="'Segoe Script', cursive">
                                <span style="font-family: 'Segoe Script', cursive">Signature</span>
                            </div>
                            <div class="font-option" data-font="Georgia, serif">
                                <span style="font-family: Georgia, serif; font-style: italic">Signature</span>
                            </div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Text Color</label>
                        <input type="color" id="typedColor" value="#000000">
                        <div class="color-presets" id="typedColorPresets">
                            <div class="color-preset active" style="background: #000000" data-color="#000000"></div>
                            <div class="color-preset" style="background: #1a237e" data-color="#1a237e"></div>
                            <div class="color-preset" style="background: #0d47a1" data-color="#0d47a1"></div>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Font Size: <span id="fontSizeValue">48</span>px</label>
                        <input type="range" id="fontSize" min="24" max="96" value="48">
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="addDateLine">
                        <label for="addDateLine">Add date line</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Tab -->
        <div class="tab-content" id="document-tab">
            <div class="document-workspace">
                <div class="document-preview">
                    <div class="document-canvas-wrapper" id="documentArea">
                        <div class="upload-zone" id="uploadZone">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 16V4m0 0L8 8m4-4l4 4M4 14v4a2 2 0 002 2h12a2 2 0 002-2v-4"/>
                            </svg>
                            <p>Drop a PDF or image here</p>
                            <p>or <span>click to browse</span></p>
                            <p class="info-text">Supports: PDF, PNG, JPG, JPEG, WEBP</p>
                        </div>
                        <canvas id="documentCanvas" style="display: none;"></canvas>
                    </div>
                    <div class="page-nav" id="pageNav" style="display: none;">
                        <button class="btn btn-secondary" id="prevPage">← Previous</button>
                        <span class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                        <button class="btn btn-secondary" id="nextPage">Next →</button>
                    </div>
                </div>
                <div class="controls-panel">
                    <h3 class="section-title">Document Controls</h3>

                    <div class="control-group">
                        <label>Select Signature to Place</label>
                        <div class="saved-signatures" id="signatureSelector">
                            <p class="info-text">No saved signatures yet. Create one in the Draw or Type tab.</p>
                        </div>
                    </div>

                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-secondary" id="addSignatureBtn" disabled>Add Selected Signature</button>
                        <button class="btn btn-danger" id="clearDocSignatures">Clear All Signatures</button>
                    </div>

                    <h3 class="section-title" style="margin-top: 30px;">Export Document</h3>

                    <div class="control-group">
                        <label>Format</label>
                        <select id="docExportFormat" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #fff;">
                            <option value="png">PNG Image</option>
                            <option value="jpeg">JPEG Image</option>
                            <option value="pdf">PDF Document</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" id="exportDocBtn" style="width: 100%; margin-top: 15px;" disabled>
                        Export Signed Document
                    </button>

                    <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.webp" style="display: none;">
                </div>
            </div>
        </div>

        <!-- Saved Signatures Tab -->
        <div class="tab-content" id="saved-tab">
            <div class="canvas-container" style="max-width: 900px; margin: 0 auto;">
                <h3 class="section-title">Your Saved Signatures</h3>
                <div class="saved-signatures" id="savedSignaturesList">
                    <p class="info-text">No saved signatures yet. Create one in the Draw or Type tab.</p>
                </div>
                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn btn-danger" id="clearAllSaved">Clear All Saved Signatures</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Signature saved!</div>

    <!-- PDF.js library for PDF handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ============ State Management ============
        const state = {
            currentTab: 'draw',
            signatures: JSON.parse(localStorage.getItem('signatures') || '[]'),
            selectedSignatureIndex: -1,
            document: {
                loaded: false,
                type: null,
                pdfDoc: null,
                currentPage: 1,
                totalPages: 1,
                image: null,
                placedSignatures: []
            },
            drawing: {
                isDrawing: false,
                lastX: 0,
                lastY: 0,
                paths: [],
                currentPath: [],
                redoStack: []
            }
        };

        // ============ DOM Elements ============
        const elements = {
            // Tabs
            tabBtns: document.querySelectorAll('.tab-btn'),
            tabContents: document.querySelectorAll('.tab-content'),

            // Draw tab
            signatureCanvas: document.getElementById('signatureCanvas'),
            strokeColor: document.getElementById('strokeColor'),
            strokeWidth: document.getElementById('strokeWidth'),
            strokeWidthValue: document.getElementById('strokeWidthValue'),
            smoothing: document.getElementById('smoothing'),
            smoothingValue: document.getElementById('smoothingValue'),
            pressureSensitive: document.getElementById('pressureSensitive'),
            undoBtn: document.getElementById('undoBtn'),
            redoBtn: document.getElementById('redoBtn'),
            clearBtn: document.getElementById('clearBtn'),
            saveSignatureBtn: document.getElementById('saveSignatureBtn'),
            exportPngBtn: document.getElementById('exportPngBtn'),
            exportSize: document.getElementById('exportSize'),
            transparentBg: document.getElementById('transparentBg'),
            colorPresets: document.querySelectorAll('#draw-tab .color-preset'),

            // Type tab
            typedCanvas: document.getElementById('typedCanvas'),
            signatureName: document.getElementById('signatureName'),
            fontOptions: document.querySelectorAll('.font-option'),
            typedColor: document.getElementById('typedColor'),
            typedColorPresets: document.querySelectorAll('#typedColorPresets .color-preset'),
            fontSize: document.getElementById('fontSize'),
            fontSizeValue: document.getElementById('fontSizeValue'),
            addDateLine: document.getElementById('addDateLine'),
            saveTypedBtn: document.getElementById('saveTypedBtn'),
            exportTypedBtn: document.getElementById('exportTypedBtn'),

            // Document tab
            uploadZone: document.getElementById('uploadZone'),
            documentArea: document.getElementById('documentArea'),
            documentCanvas: document.getElementById('documentCanvas'),
            fileInput: document.getElementById('fileInput'),
            pageNav: document.getElementById('pageNav'),
            prevPage: document.getElementById('prevPage'),
            nextPage: document.getElementById('nextPage'),
            currentPageSpan: document.getElementById('currentPage'),
            totalPagesSpan: document.getElementById('totalPages'),
            signatureSelector: document.getElementById('signatureSelector'),
            addSignatureBtn: document.getElementById('addSignatureBtn'),
            clearDocSignatures: document.getElementById('clearDocSignatures'),
            docExportFormat: document.getElementById('docExportFormat'),
            exportDocBtn: document.getElementById('exportDocBtn'),

            // Saved tab
            savedSignaturesList: document.getElementById('savedSignaturesList'),
            clearAllSaved: document.getElementById('clearAllSaved'),

            // Toast
            toast: document.getElementById('toast')
        };

        const signatureCtx = elements.signatureCanvas.getContext('2d');
        const typedCtx = elements.typedCanvas.getContext('2d');
        const documentCtx = elements.documentCanvas.getContext('2d');

        // ============ Tab Management ============
        elements.tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;

                elements.tabBtns.forEach(b => b.classList.remove('active'));
                elements.tabContents.forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(`${tab}-tab`).classList.add('active');

                state.currentTab = tab;

                if (tab === 'saved') updateSavedSignaturesList();
                if (tab === 'document') updateSignatureSelector();
            });
        });

        // ============ Drawing Signature ============
        function initDrawingCanvas() {
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';
            signatureCtx.strokeStyle = elements.strokeColor.value;
            signatureCtx.lineWidth = elements.strokeWidth.value;

            clearCanvas();
        }

        function clearCanvas() {
            signatureCtx.clearRect(0, 0, elements.signatureCanvas.width, elements.signatureCanvas.height);
            state.drawing.paths = [];
            state.drawing.currentPath = [];
            state.drawing.redoStack = [];
        }

        function getPointerPos(e) {
            const rect = elements.signatureCanvas.getBoundingClientRect();
            const scaleX = elements.signatureCanvas.width / rect.width;
            const scaleY = elements.signatureCanvas.height / rect.height;

            if (e.touches) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX,
                    y: (e.touches[0].clientY - rect.top) * scaleY,
                    pressure: e.touches[0].force || 0.5
                };
            }

            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY,
                pressure: e.pressure || 0.5
            };
        }

        function startDrawing(e) {
            e.preventDefault();
            state.drawing.isDrawing = true;
            state.drawing.redoStack = [];

            const pos = getPointerPos(e);
            state.drawing.lastX = pos.x;
            state.drawing.lastY = pos.y;
            state.drawing.currentPath = [{
                x: pos.x,
                y: pos.y,
                pressure: pos.pressure,
                color: elements.strokeColor.value,
                width: elements.strokeWidth.value
            }];
        }

        function draw(e) {
            if (!state.drawing.isDrawing) return;
            e.preventDefault();

            const pos = getPointerPos(e);
            const smoothing = parseFloat(elements.smoothing.value);

            // Apply smoothing
            const x = state.drawing.lastX + (pos.x - state.drawing.lastX) * (1 - smoothing);
            const y = state.drawing.lastY + (pos.y - state.drawing.lastY) * (1 - smoothing);

            let width = parseFloat(elements.strokeWidth.value);
            if (elements.pressureSensitive.checked) {
                width = width * (0.5 + pos.pressure * 0.5);
            }

            signatureCtx.beginPath();
            signatureCtx.strokeStyle = elements.strokeColor.value;
            signatureCtx.lineWidth = width;
            signatureCtx.moveTo(state.drawing.lastX, state.drawing.lastY);
            signatureCtx.lineTo(x, y);
            signatureCtx.stroke();

            state.drawing.currentPath.push({
                x: x,
                y: y,
                pressure: pos.pressure,
                color: elements.strokeColor.value,
                width: width
            });

            state.drawing.lastX = x;
            state.drawing.lastY = y;
        }

        function stopDrawing() {
            if (state.drawing.isDrawing && state.drawing.currentPath.length > 1) {
                state.drawing.paths.push([...state.drawing.currentPath]);
            }
            state.drawing.isDrawing = false;
            state.drawing.currentPath = [];
        }

        function redrawCanvas() {
            signatureCtx.clearRect(0, 0, elements.signatureCanvas.width, elements.signatureCanvas.height);

            state.drawing.paths.forEach(path => {
                if (path.length < 2) return;

                for (let i = 1; i < path.length; i++) {
                    signatureCtx.beginPath();
                    signatureCtx.strokeStyle = path[i].color;
                    signatureCtx.lineWidth = path[i].width;
                    signatureCtx.moveTo(path[i-1].x, path[i-1].y);
                    signatureCtx.lineTo(path[i].x, path[i].y);
                    signatureCtx.stroke();
                }
            });
        }

        function undo() {
            if (state.drawing.paths.length > 0) {
                state.drawing.redoStack.push(state.drawing.paths.pop());
                redrawCanvas();
            }
        }

        function redo() {
            if (state.drawing.redoStack.length > 0) {
                state.drawing.paths.push(state.drawing.redoStack.pop());
                redrawCanvas();
            }
        }

        // Event listeners for drawing
        elements.signatureCanvas.addEventListener('mousedown', startDrawing);
        elements.signatureCanvas.addEventListener('mousemove', draw);
        elements.signatureCanvas.addEventListener('mouseup', stopDrawing);
        elements.signatureCanvas.addEventListener('mouseleave', stopDrawing);

        elements.signatureCanvas.addEventListener('touchstart', startDrawing, { passive: false });
        elements.signatureCanvas.addEventListener('touchmove', draw, { passive: false });
        elements.signatureCanvas.addEventListener('touchend', stopDrawing);

        elements.undoBtn.addEventListener('click', undo);
        elements.redoBtn.addEventListener('click', redo);
        elements.clearBtn.addEventListener('click', clearCanvas);

        // Control listeners
        elements.strokeWidth.addEventListener('input', (e) => {
            elements.strokeWidthValue.textContent = e.target.value;
        });

        elements.smoothing.addEventListener('input', (e) => {
            elements.smoothingValue.textContent = e.target.value;
        });

        elements.colorPresets.forEach(preset => {
            preset.addEventListener('click', () => {
                elements.colorPresets.forEach(p => p.classList.remove('active'));
                preset.classList.add('active');
                elements.strokeColor.value = preset.dataset.color;
            });
        });

        elements.strokeColor.addEventListener('input', () => {
            elements.colorPresets.forEach(p => p.classList.remove('active'));
        });

        // ============ Typed Signature ============
        let selectedFont = "'Brush Script MT', cursive";

        function renderTypedSignature() {
            const name = elements.signatureName.value || 'Your Name';
            const fontSize = parseInt(elements.fontSize.value);
            const color = elements.typedColor.value;
            const addDate = elements.addDateLine.checked;

            typedCtx.clearRect(0, 0, elements.typedCanvas.width, elements.typedCanvas.height);

            typedCtx.font = `${fontSize}px ${selectedFont}`;
            typedCtx.fillStyle = color;
            typedCtx.textAlign = 'center';
            typedCtx.textBaseline = 'middle';

            const y = addDate ? elements.typedCanvas.height / 2 - 20 : elements.typedCanvas.height / 2;
            typedCtx.fillText(name, elements.typedCanvas.width / 2, y);

            if (addDate) {
                const date = new Date().toLocaleDateString();
                typedCtx.font = `${fontSize * 0.3}px sans-serif`;
                typedCtx.fillText(date, elements.typedCanvas.width / 2, y + fontSize * 0.6);
            }
        }

        elements.signatureName.addEventListener('input', renderTypedSignature);
        elements.fontSize.addEventListener('input', (e) => {
            elements.fontSizeValue.textContent = e.target.value;
            renderTypedSignature();
        });
        elements.typedColor.addEventListener('input', renderTypedSignature);
        elements.addDateLine.addEventListener('change', renderTypedSignature);

        elements.fontOptions.forEach(opt => {
            opt.addEventListener('click', () => {
                elements.fontOptions.forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                selectedFont = opt.dataset.font;
                renderTypedSignature();
            });
        });

        elements.typedColorPresets.forEach(preset => {
            preset.addEventListener('click', () => {
                elements.typedColorPresets.forEach(p => p.classList.remove('active'));
                preset.classList.add('active');
                elements.typedColor.value = preset.dataset.color;
                renderTypedSignature();
            });
        });

        // ============ Save Signature ============
        function getSignatureDataURL(canvas, transparent = true) {
            // Get the bounds of the actual signature
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;

            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const alpha = data[(y * canvas.width + x) * 4 + 3];
                    if (alpha > 0) {
                        minX = Math.min(minX, x);
                        minY = Math.min(minY, y);
                        maxX = Math.max(maxX, x);
                        maxY = Math.max(maxY, y);
                    }
                }
            }

            if (minX > maxX || minY > maxY) return null;

            const padding = 20;
            minX = Math.max(0, minX - padding);
            minY = Math.max(0, minY - padding);
            maxX = Math.min(canvas.width, maxX + padding);
            maxY = Math.min(canvas.height, maxY + padding);

            const width = maxX - minX;
            const height = maxY - minY;

            const croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = width;
            croppedCanvas.height = height;
            const croppedCtx = croppedCanvas.getContext('2d');

            if (!transparent) {
                croppedCtx.fillStyle = '#ffffff';
                croppedCtx.fillRect(0, 0, width, height);
            }

            croppedCtx.drawImage(canvas, minX, minY, width, height, 0, 0, width, height);

            return croppedCanvas.toDataURL('image/png');
        }

        function saveSignature(canvas) {
            const dataURL = getSignatureDataURL(canvas, true);
            if (!dataURL) {
                showToast('Please draw a signature first');
                return;
            }

            state.signatures.push({
                data: dataURL,
                date: new Date().toISOString()
            });

            localStorage.setItem('signatures', JSON.stringify(state.signatures));
            showToast('Signature saved!');
            updateSignatureSelector();
            updateSavedSignaturesList();
        }

        elements.saveSignatureBtn.addEventListener('click', () => saveSignature(elements.signatureCanvas));
        elements.saveTypedBtn.addEventListener('click', () => saveSignature(elements.typedCanvas));

        // ============ Export Signature ============
        function exportSignature(canvas) {
            const scale = parseFloat(elements.exportSize.value);
            const transparent = elements.transparentBg.checked;

            const dataURL = getSignatureDataURL(canvas, transparent);
            if (!dataURL) {
                showToast('Please draw a signature first');
                return;
            }

            // Load and scale the image
            const img = new Image();
            img.onload = () => {
                const scaledCanvas = document.createElement('canvas');
                scaledCanvas.width = img.width * scale;
                scaledCanvas.height = img.height * scale;
                const ctx = scaledCanvas.getContext('2d');

                if (!transparent) {
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, scaledCanvas.width, scaledCanvas.height);
                }

                ctx.drawImage(img, 0, 0, scaledCanvas.width, scaledCanvas.height);

                const link = document.createElement('a');
                link.download = `signature-${Date.now()}.png`;
                link.href = scaledCanvas.toDataURL('image/png');
                link.click();

                showToast('Signature exported!');
            };
            img.src = dataURL;
        }

        elements.exportPngBtn.addEventListener('click', () => exportSignature(elements.signatureCanvas));
        elements.exportTypedBtn.addEventListener('click', () => exportSignature(elements.typedCanvas));

        // ============ Document Handling ============
        function handleFileUpload(file) {
            if (!file) return;

            const isPDF = file.type === 'application/pdf';
            const isImage = file.type.startsWith('image/');

            if (!isPDF && !isImage) {
                showToast('Please upload a PDF or image file');
                return;
            }

            state.document.placedSignatures = [];
            clearSignatureOverlays();

            if (isPDF) {
                loadPDF(file);
            } else {
                loadImage(file);
            }
        }

        async function loadPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            state.document.pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            state.document.type = 'pdf';
            state.document.totalPages = state.document.pdfDoc.numPages;
            state.document.currentPage = 1;
            state.document.loaded = true;

            elements.totalPagesSpan.textContent = state.document.totalPages;
            elements.pageNav.style.display = state.document.totalPages > 1 ? 'flex' : 'none';

            renderPDFPage(1);
        }

        async function renderPDFPage(pageNum) {
            const page = await state.document.pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });

            elements.documentCanvas.width = viewport.width;
            elements.documentCanvas.height = viewport.height;

            await page.render({
                canvasContext: documentCtx,
                viewport: viewport
            }).promise;

            elements.uploadZone.style.display = 'none';
            elements.documentCanvas.style.display = 'block';
            elements.exportDocBtn.disabled = false;
            elements.currentPageSpan.textContent = pageNum;

            // Redraw placed signatures
            redrawSignaturesOnDocument();
        }

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    state.document.image = img;
                    state.document.type = 'image';
                    state.document.loaded = true;

                    elements.documentCanvas.width = img.width;
                    elements.documentCanvas.height = img.height;
                    documentCtx.drawImage(img, 0, 0);

                    elements.uploadZone.style.display = 'none';
                    elements.documentCanvas.style.display = 'block';
                    elements.pageNav.style.display = 'none';
                    elements.exportDocBtn.disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // File upload handlers
        elements.uploadZone.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

        elements.uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.uploadZone.style.borderColor = '#667eea';
        });

        elements.uploadZone.addEventListener('dragleave', () => {
            elements.uploadZone.style.borderColor = 'rgba(255, 255, 255, 0.2)';
        });

        elements.uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.uploadZone.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            handleFileUpload(e.dataTransfer.files[0]);
        });

        // Page navigation
        elements.prevPage.addEventListener('click', () => {
            if (state.document.currentPage > 1) {
                state.document.currentPage--;
                renderPDFPage(state.document.currentPage);
            }
        });

        elements.nextPage.addEventListener('click', () => {
            if (state.document.currentPage < state.document.totalPages) {
                state.document.currentPage++;
                renderPDFPage(state.document.currentPage);
            }
        });

        // ============ Signature Placement ============
        function updateSignatureSelector() {
            if (state.signatures.length === 0) {
                elements.signatureSelector.innerHTML = '<p class="info-text">No saved signatures yet. Create one in the Draw or Type tab.</p>';
                elements.addSignatureBtn.disabled = true;
                return;
            }

            elements.signatureSelector.innerHTML = state.signatures.map((sig, i) => `
                <div class="saved-signature ${state.selectedSignatureIndex === i ? 'selected' : ''}" data-index="${i}" style="${state.selectedSignatureIndex === i ? 'border: 2px solid #667eea;' : ''}">
                    <img src="${sig.data}" alt="Signature ${i + 1}">
                </div>
            `).join('');

            elements.signatureSelector.querySelectorAll('.saved-signature').forEach(el => {
                el.addEventListener('click', () => {
                    state.selectedSignatureIndex = parseInt(el.dataset.index);
                    updateSignatureSelector();
                    elements.addSignatureBtn.disabled = false;
                });
            });
        }

        function updateSavedSignaturesList() {
            if (state.signatures.length === 0) {
                elements.savedSignaturesList.innerHTML = '<p class="info-text">No saved signatures yet. Create one in the Draw or Type tab.</p>';
                return;
            }

            elements.savedSignaturesList.innerHTML = state.signatures.map((sig, i) => `
                <div class="saved-signature" data-index="${i}">
                    <img src="${sig.data}" alt="Signature ${i + 1}">
                    <div class="delete-saved" data-index="${i}">×</div>
                </div>
            `).join('');

            elements.savedSignaturesList.querySelectorAll('.delete-saved').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.dataset.index);
                    state.signatures.splice(index, 1);
                    localStorage.setItem('signatures', JSON.stringify(state.signatures));
                    updateSavedSignaturesList();
                    updateSignatureSelector();
                    showToast('Signature deleted');
                });
            });
        }

        elements.clearAllSaved.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete all saved signatures?')) {
                state.signatures = [];
                localStorage.setItem('signatures', JSON.stringify(state.signatures));
                updateSavedSignaturesList();
                updateSignatureSelector();
                showToast('All signatures deleted');
            }
        });

        // Add signature to document
        elements.addSignatureBtn.addEventListener('click', () => {
            if (!state.document.loaded) {
                showToast('Please load a document first');
                return;
            }

            if (state.selectedSignatureIndex < 0) {
                showToast('Please select a signature first');
                return;
            }

            addSignatureOverlay(state.signatures[state.selectedSignatureIndex].data);
        });

        function addSignatureOverlay(dataURL) {
            const overlay = document.createElement('div');
            overlay.className = 'signature-overlay';
            overlay.innerHTML = `
                <img src="${dataURL}" alt="Signature">
                <div class="resize-handle"></div>
                <div class="rotate-handle"></div>
                <div class="delete-handle">×</div>
            `;

            const rect = elements.documentCanvas.getBoundingClientRect();
            overlay.style.left = `${rect.left + 50}px`;
            overlay.style.top = `${rect.top + 50}px`;
            overlay.style.width = '200px';

            document.body.appendChild(overlay);

            makeOverlayDraggable(overlay);
            makeOverlayResizable(overlay);

            overlay.querySelector('.delete-handle').addEventListener('click', () => {
                overlay.remove();
            });

            state.document.placedSignatures.push(overlay);
        }

        function makeOverlayDraggable(overlay) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            overlay.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle') ||
                    e.target.classList.contains('delete-handle') ||
                    e.target.classList.contains('rotate-handle')) return;

                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialX = overlay.offsetLeft;
                initialY = overlay.offsetTop;
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                overlay.style.left = `${initialX + dx}px`;
                overlay.style.top = `${initialY + dy}px`;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        function makeOverlayResizable(overlay) {
            const handle = overlay.querySelector('.resize-handle');
            let isResizing = false;
            let startX, startWidth;

            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isResizing = true;
                startX = e.clientX;
                startWidth = overlay.offsetWidth;
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;

                const dx = e.clientX - startX;
                const newWidth = Math.max(100, startWidth + dx);
                overlay.style.width = `${newWidth}px`;
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
            });
        }

        function clearSignatureOverlays() {
            state.document.placedSignatures.forEach(overlay => overlay.remove());
            state.document.placedSignatures = [];
        }

        elements.clearDocSignatures.addEventListener('click', clearSignatureOverlays);

        function redrawSignaturesOnDocument() {
            // This would redraw after page change - simplified for this implementation
        }

        // ============ Export Document ============
        elements.exportDocBtn.addEventListener('click', async () => {
            if (!state.document.loaded) return;

            const format = elements.docExportFormat.value;

            // Create final canvas with signatures
            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = elements.documentCanvas.width;
            finalCanvas.height = elements.documentCanvas.height;
            const finalCtx = finalCanvas.getContext('2d');

            // Draw document
            finalCtx.drawImage(elements.documentCanvas, 0, 0);

            // Draw each signature overlay
            const canvasRect = elements.documentCanvas.getBoundingClientRect();

            for (const overlay of state.document.placedSignatures) {
                const img = overlay.querySelector('img');
                const overlayRect = overlay.getBoundingClientRect();

                const x = (overlayRect.left - canvasRect.left) * (elements.documentCanvas.width / canvasRect.width);
                const y = (overlayRect.top - canvasRect.top) * (elements.documentCanvas.height / canvasRect.height);
                const width = overlayRect.width * (elements.documentCanvas.width / canvasRect.width);
                const height = overlayRect.height * (elements.documentCanvas.height / canvasRect.height);

                finalCtx.drawImage(img, x, y, width, height);
            }

            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: finalCanvas.width > finalCanvas.height ? 'landscape' : 'portrait',
                    unit: 'px',
                    format: [finalCanvas.width, finalCanvas.height]
                });

                pdf.addImage(finalCanvas.toDataURL('image/png'), 'PNG', 0, 0, finalCanvas.width, finalCanvas.height);
                pdf.save(`signed-document-${Date.now()}.pdf`);
            } else {
                const link = document.createElement('a');
                link.download = `signed-document-${Date.now()}.${format}`;
                link.href = finalCanvas.toDataURL(`image/${format}`);
                link.click();
            }

            showToast('Document exported!');
        });

        // ============ Toast ============
        function showToast(message) {
            elements.toast.textContent = message;
            elements.toast.classList.add('show');
            setTimeout(() => elements.toast.classList.remove('show'), 2500);
        }

        // ============ Initialize ============
        initDrawingCanvas();
        renderTypedSignature();
        updateSignatureSelector();
        updateSavedSignaturesList();

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z') {
                    e.preventDefault();
                    undo();
                } else if (e.key === 'y') {
                    e.preventDefault();
                    redo();
                }
            }
        });
    </script>
</body>
</html>
