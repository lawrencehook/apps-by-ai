<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Story Builder - AI Showcase</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: system-ui, -apple-system, sans-serif;
            color: #fff;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        h1 { font-size: 1.8rem; }
        h1 span { color: #4ecdc4; }
        .back-link {
            color: #888;
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            transition: all 0.2s;
        }
        .back-link:hover { color: #fff; border-color: rgba(255,255,255,0.3); }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 24px;
        }

        .sidebar {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 12px;
        }

        .data-input {
            margin-bottom: 24px;
        }

        textarea {
            width: 100%;
            height: 200px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: #fff;
            padding: 12px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            resize: vertical;
        }
        textarea:focus { outline: none; border-color: #4ecdc4; }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        button {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
            color: #4ecdc4;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        button:hover { background: rgba(78, 205, 196, 0.3); }
        button.secondary {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.2);
            color: #aaa;
        }
        button.secondary:hover { background: rgba(255,255,255,0.1); color: #fff; }
        button.active {
            background: #4ecdc4;
            color: #1a1a2e;
        }

        .chart-types {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        .chart-type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chart-type-btn:hover { background: rgba(255,255,255,0.1); }
        .chart-type-btn.active {
            background: rgba(78, 205, 196, 0.2);
            border-color: #4ecdc4;
        }
        .chart-type-btn svg { width: 32px; height: 32px; margin-bottom: 8px; }
        .chart-type-btn span { font-size: 12px; color: #aaa; }
        .chart-type-btn.active span { color: #4ecdc4; }

        .options-group {
            margin-bottom: 20px;
        }

        .option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .option-row label {
            font-size: 13px;
            color: #ccc;
        }

        input[type="color"] {
            width: 40px;
            height: 28px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
        }

        input[type="range"] {
            width: 120px;
            accent-color: #4ecdc4;
        }

        input[type="number"], select {
            width: 100px;
            padding: 6px 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
        }

        .chart-area {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 500;
        }

        .chart-title input {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.4rem;
            font-weight: 500;
            width: 300px;
        }
        .chart-title input:focus { outline: none; border-bottom: 1px solid #4ecdc4; }

        .chart-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 500px;
        }

        #chart {
            width: 100%;
            height: 100%;
        }

        .animation-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .timeline {
            flex: 1;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #ff6b6b);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .timeline-markers {
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
        }

        .marker {
            font-size: 11px;
            color: #666;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #888;
            font-size: 13px;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 60px;
        }
        .empty-state svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.3; }
        .empty-state p { margin-bottom: 20px; }

        /* Chart styles */
        .bar-chart, .line-chart, .pie-chart, .area-chart {
            width: 100%;
            height: 100%;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        .axis-label {
            fill: #888;
            font-size: 11px;
        }

        .axis-line {
            stroke: rgba(255,255,255,0.1);
        }

        .grid-line {
            stroke: rgba(255,255,255,0.05);
        }

        .data-bar {
            transition: all 0.3s ease-out;
        }

        .data-line {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .data-point {
            transition: all 0.3s ease-out;
        }

        .data-area {
            opacity: 0.3;
        }

        .pie-slice {
            transition: all 0.3s ease-out;
            cursor: pointer;
        }
        .pie-slice:hover {
            filter: brightness(1.2);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #ccc;
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 3px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
        }
        .tooltip.visible { opacity: 1; }
        .tooltip-label { color: #888; margin-bottom: 4px; }
        .tooltip-value { font-size: 18px; font-weight: 600; color: #4ecdc4; }

        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Data <span>Story</span> Builder</h1>
            <a href="../../index.html" class="back-link">Back</a>
        </header>

        <div class="main-layout">
            <div class="sidebar">
                <div class="data-input">
                    <div class="section-title">Data Input</div>
                    <textarea id="dataInput" placeholder='Paste CSV or JSON data here...

Example CSV:
Month,Sales,Expenses
Jan,4000,3000
Feb,5200,3200
Mar,4800,2900

Example JSON:
[
  {"label": "Jan", "value": 4000},
  {"label": "Feb", "value": 5200}
]'></textarea>
                    <div class="btn-row">
                        <button onclick="parseData()">Parse Data</button>
                        <button class="secondary" onclick="loadSampleData()">Load Sample</button>
                        <button class="secondary" onclick="clearData()">Clear</button>
                    </div>
                </div>

                <div class="section-title">Chart Type</div>
                <div class="chart-types">
                    <div class="chart-type-btn active" data-type="bar" onclick="setChartType('bar')">
                        <svg viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="4" y="16" width="6" height="12" fill="#4ecdc4" stroke="none"/>
                            <rect x="13" y="8" width="6" height="20" fill="#ff6b6b" stroke="none"/>
                            <rect x="22" y="12" width="6" height="16" fill="#ffe66d" stroke="none"/>
                        </svg>
                        <span>Bar</span>
                    </div>
                    <div class="chart-type-btn" data-type="line" onclick="setChartType('line')">
                        <svg viewBox="0 0 32 32" fill="none" stroke="#4ecdc4" stroke-width="2.5">
                            <polyline points="4,24 12,12 20,18 28,6"/>
                            <circle cx="4" cy="24" r="2" fill="#4ecdc4"/>
                            <circle cx="12" cy="12" r="2" fill="#4ecdc4"/>
                            <circle cx="20" cy="18" r="2" fill="#4ecdc4"/>
                            <circle cx="28" cy="6" r="2" fill="#4ecdc4"/>
                        </svg>
                        <span>Line</span>
                    </div>
                    <div class="chart-type-btn" data-type="pie" onclick="setChartType('pie')">
                        <svg viewBox="0 0 32 32" fill="none">
                            <path d="M16,16 L16,4 A12,12 0 0,1 26.4,22" fill="#4ecdc4"/>
                            <path d="M16,16 L26.4,22 A12,12 0 0,1 8,24" fill="#ff6b6b"/>
                            <path d="M16,16 L8,24 A12,12 0 0,1 16,4" fill="#ffe66d"/>
                        </svg>
                        <span>Pie</span>
                    </div>
                    <div class="chart-type-btn" data-type="area" onclick="setChartType('area')">
                        <svg viewBox="0 0 32 32" fill="none">
                            <path d="M4,28 L4,20 Q10,8 16,14 T28,10 L28,28 Z" fill="rgba(78,205,196,0.3)" stroke="#4ecdc4" stroke-width="2"/>
                        </svg>
                        <span>Area</span>
                    </div>
                </div>

                <div class="section-title">Appearance</div>
                <div class="options-group">
                    <div class="option-row">
                        <label>Primary Color</label>
                        <input type="color" id="primaryColor" value="#4ecdc4" onchange="updateChart()">
                    </div>
                    <div class="option-row">
                        <label>Secondary Color</label>
                        <input type="color" id="secondaryColor" value="#ff6b6b" onchange="updateChart()">
                    </div>
                    <div class="option-row">
                        <label>Animation Speed</label>
                        <input type="range" id="animSpeed" min="500" max="3000" value="1500" onchange="updateAnimSpeed()">
                    </div>
                    <div class="option-row">
                        <label>Show Grid</label>
                        <input type="checkbox" id="showGrid" checked onchange="updateChart()">
                    </div>
                    <div class="option-row">
                        <label>Show Values</label>
                        <input type="checkbox" id="showValues" checked onchange="updateChart()">
                    </div>
                </div>

                <div class="section-title">Export</div>
                <div class="btn-row">
                    <button onclick="exportSVG()">Export SVG</button>
                    <button class="secondary" onclick="exportPNG()">Export PNG</button>
                </div>
            </div>

            <div class="chart-area">
                <div class="chart-header">
                    <div class="chart-title">
                        <input type="text" id="chartTitle" value="My Data Story" placeholder="Chart Title">
                    </div>
                </div>

                <div class="chart-container" id="chartContainer">
                    <div class="empty-state" id="emptyState">
                        <svg viewBox="0 0 80 80" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="10" y="40" width="12" height="30" rx="2"/>
                            <rect x="34" y="20" width="12" height="50" rx="2"/>
                            <rect x="58" y="30" width="12" height="40" rx="2"/>
                        </svg>
                        <p>Paste your data and click "Parse Data" to create animated visualizations</p>
                        <button onclick="loadSampleData()">Load Sample Data</button>
                    </div>
                    <svg id="chart" class="chart-svg" style="display: none;"></svg>
                    <div class="tooltip" id="tooltip"></div>
                </div>

                <div class="legend" id="legend" style="display: none;"></div>

                <div class="animation-controls" id="animControls" style="display: none;">
                    <button class="play-btn" id="playBtn" onclick="toggleAnimation()">
                        <span id="playIcon">&#9658;</span>
                    </button>
                    <div class="timeline" onclick="seekAnimation(event)">
                        <div class="timeline-progress" id="timelineProgress"></div>
                    </div>
                    <div class="speed-control">
                        <span>Speed:</span>
                        <select id="speedSelect" onchange="setSpeed()">
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x</option>
                            <option value="2">2x</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let chartData = null;
        let chartType = 'bar';
        let isPlaying = false;
        let animationProgress = 0;
        let animationFrame = null;
        let animDuration = 1500;
        let animStartTime = null;
        let speed = 1;

        // Color palette
        const colors = [
            '#4ecdc4', '#ff6b6b', '#ffe66d', '#a29bfe', '#fd79a8',
            '#00b894', '#0984e3', '#6c5ce7', '#fdcb6e', '#e17055'
        ];

        function parseCSV(text) {
            const lines = text.trim().split('\n').filter(l => l.trim());
            if (lines.length < 2) return null;

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((h, idx) => {
                    const val = values[idx];
                    row[h] = isNaN(val) ? val : parseFloat(val);
                });
                data.push(row);
            }

            return { headers, data };
        }

        function parseJSON(text) {
            try {
                const json = JSON.parse(text);
                if (Array.isArray(json) && json.length > 0) {
                    const headers = Object.keys(json[0]);
                    return { headers, data: json };
                }
            } catch (e) {}
            return null;
        }

        function parseData() {
            const input = document.getElementById('dataInput').value.trim();
            if (!input) return;

            // Try JSON first, then CSV
            let parsed = parseJSON(input) || parseCSV(input);

            if (!parsed || !parsed.data.length) {
                alert('Could not parse data. Please check format.');
                return;
            }

            chartData = parsed;
            updateChart();
        }

        function loadSampleData() {
            const samples = [
                {
                    name: 'Monthly Sales',
                    data: `Month,Sales,Expenses,Profit
Jan,45000,32000,13000
Feb,52000,35000,17000
Mar,48000,31000,17000
Apr,61000,38000,23000
May,55000,34000,21000
Jun,67000,42000,25000`
                },
                {
                    name: 'Website Traffic',
                    data: `Week,Visitors,Signups,Conversions
Week 1,12500,450,89
Week 2,15800,520,112
Week 3,14200,480,95
Week 4,18900,680,156
Week 5,21000,750,189
Week 6,19500,710,168`
                },
                {
                    name: 'Product Categories',
                    data: `Category,Revenue
Electronics,125000
Clothing,89000
Home & Garden,67000
Sports,54000
Books,32000
Toys,28000`
                }
            ];

            const sample = samples[Math.floor(Math.random() * samples.length)];
            document.getElementById('dataInput').value = sample.data;
            document.getElementById('chartTitle').value = sample.name;
            parseData();
        }

        function clearData() {
            document.getElementById('dataInput').value = '';
            chartData = null;
            document.getElementById('chart').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('legend').style.display = 'none';
            document.getElementById('animControls').style.display = 'none';
        }

        function setChartType(type) {
            chartType = type;
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            if (chartData) updateChart();
        }

        function updateChart() {
            if (!chartData) return;

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('chart').style.display = 'block';
            document.getElementById('animControls').style.display = 'flex';

            stopAnimation();
            animationProgress = 0;

            switch (chartType) {
                case 'bar': renderBarChart(); break;
                case 'line': renderLineChart(); break;
                case 'pie': renderPieChart(); break;
                case 'area': renderAreaChart(); break;
            }

            playAnimation();
        }

        function getChartColors() {
            return [
                document.getElementById('primaryColor').value,
                document.getElementById('secondaryColor').value,
                ...colors.slice(2)
            ];
        }

        function renderBarChart() {
            const svg = document.getElementById('chart');
            const rect = svg.getBoundingClientRect();
            const width = rect.width || 800;
            const height = rect.height || 500;
            const padding = { top: 40, right: 40, bottom: 60, left: 70 };

            const { headers, data } = chartData;
            const labelKey = headers[0];
            const valueKeys = headers.slice(1).filter(h => typeof data[0][h] === 'number');
            const chartColors = getChartColors();

            // Calculate scales
            const maxVal = Math.max(...data.flatMap(d => valueKeys.map(k => d[k])));
            const barGroupWidth = (width - padding.left - padding.right) / data.length;
            const barWidth = Math.min(40, (barGroupWidth - 20) / valueKeys.length);
            const showGrid = document.getElementById('showGrid').checked;
            const showValues = document.getElementById('showValues').checked;

            let html = `<svg viewBox="0 0 ${width} ${height}" class="chart-svg">`;

            // Grid lines
            if (showGrid) {
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (height - padding.top - padding.bottom) * (1 - i / 5);
                    html += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" class="grid-line"/>`;
                    html += `<text x="${padding.left - 10}" y="${y + 4}" class="axis-label" text-anchor="end">${Math.round(maxVal * i / 5).toLocaleString()}</text>`;
                }
            }

            // Axis
            html += `<line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" class="axis-line" stroke-width="2"/>`;

            // Bars
            data.forEach((d, i) => {
                const groupX = padding.left + i * barGroupWidth + barGroupWidth / 2;

                // Label
                html += `<text x="${groupX}" y="${height - padding.bottom + 25}" class="axis-label" text-anchor="middle">${d[labelKey]}</text>`;

                valueKeys.forEach((key, j) => {
                    const val = d[key];
                    const barHeight = (val / maxVal) * (height - padding.top - padding.bottom);
                    const x = groupX - (valueKeys.length * barWidth) / 2 + j * barWidth + 2;
                    const y = height - padding.bottom - barHeight;

                    html += `<rect class="data-bar" data-label="${d[labelKey]}" data-key="${key}" data-value="${val}"
                        x="${x}" y="${height - padding.bottom}" width="${barWidth - 4}" height="0"
                        fill="${chartColors[j % chartColors.length]}" rx="3"
                        style="--target-y: ${y}px; --target-height: ${barHeight}px"/>`;

                    if (showValues) {
                        html += `<text class="bar-value" x="${x + barWidth / 2 - 2}" y="${y - 8}"
                            fill="${chartColors[j % chartColors.length]}" font-size="11" text-anchor="middle" opacity="0"
                            style="--target-y: ${y - 8}px">${val.toLocaleString()}</text>`;
                    }
                });
            });

            html += '</svg>';
            svg.outerHTML = html;

            // Render legend
            renderLegend(valueKeys, chartColors);
            setupTooltips();
        }

        function renderLineChart() {
            const svg = document.getElementById('chart');
            const rect = svg.getBoundingClientRect();
            const width = rect.width || 800;
            const height = rect.height || 500;
            const padding = { top: 40, right: 40, bottom: 60, left: 70 };

            const { headers, data } = chartData;
            const labelKey = headers[0];
            const valueKeys = headers.slice(1).filter(h => typeof data[0][h] === 'number');
            const chartColors = getChartColors();

            const maxVal = Math.max(...data.flatMap(d => valueKeys.map(k => d[k])));
            const pointSpacing = (width - padding.left - padding.right) / (data.length - 1 || 1);
            const showGrid = document.getElementById('showGrid').checked;
            const showValues = document.getElementById('showValues').checked;

            let html = `<svg viewBox="0 0 ${width} ${height}" class="chart-svg">`;

            // Grid
            if (showGrid) {
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (height - padding.top - padding.bottom) * (1 - i / 5);
                    html += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" class="grid-line"/>`;
                    html += `<text x="${padding.left - 10}" y="${y + 4}" class="axis-label" text-anchor="end">${Math.round(maxVal * i / 5).toLocaleString()}</text>`;
                }
            }

            // X labels
            data.forEach((d, i) => {
                const x = padding.left + i * pointSpacing;
                html += `<text x="${x}" y="${height - padding.bottom + 25}" class="axis-label" text-anchor="middle">${d[labelKey]}</text>`;
            });

            // Lines and points
            valueKeys.forEach((key, keyIdx) => {
                const color = chartColors[keyIdx % chartColors.length];
                let pathD = '';
                let points = [];

                data.forEach((d, i) => {
                    const x = padding.left + i * pointSpacing;
                    const y = height - padding.bottom - (d[key] / maxVal) * (height - padding.top - padding.bottom);
                    points.push({ x, y, val: d[key], label: d[labelKey] });
                    pathD += (i === 0 ? 'M' : 'L') + `${x},${y}`;
                });

                // Line
                const pathLength = points.length * 200;
                html += `<path class="data-line" d="${pathD}" stroke="${color}"
                    stroke-dasharray="${pathLength}" stroke-dashoffset="${pathLength}"
                    style="--path-length: ${pathLength}"/>`;

                // Points
                points.forEach((p, i) => {
                    html += `<circle class="data-point" data-label="${p.label}" data-key="${key}" data-value="${p.val}"
                        cx="${p.x}" cy="${p.y}" r="0" fill="${color}" stroke="#1a1a2e" stroke-width="2"
                        style="--target-r: 6"/>`;

                    if (showValues) {
                        html += `<text class="point-value" x="${p.x}" y="${p.y - 15}"
                            fill="${color}" font-size="11" text-anchor="middle" opacity="0">${p.val.toLocaleString()}</text>`;
                    }
                });
            });

            html += '</svg>';
            svg.outerHTML = html;

            renderLegend(valueKeys, chartColors);
            setupTooltips();
        }

        function renderAreaChart() {
            const svg = document.getElementById('chart');
            const rect = svg.getBoundingClientRect();
            const width = rect.width || 800;
            const height = rect.height || 500;
            const padding = { top: 40, right: 40, bottom: 60, left: 70 };

            const { headers, data } = chartData;
            const labelKey = headers[0];
            const valueKeys = headers.slice(1).filter(h => typeof data[0][h] === 'number');
            const chartColors = getChartColors();

            const maxVal = Math.max(...data.flatMap(d => valueKeys.map(k => d[k])));
            const pointSpacing = (width - padding.left - padding.right) / (data.length - 1 || 1);
            const showGrid = document.getElementById('showGrid').checked;
            const baseY = height - padding.bottom;

            let html = `<svg viewBox="0 0 ${width} ${height}" class="chart-svg">`;

            // Grid
            if (showGrid) {
                for (let i = 0; i <= 5; i++) {
                    const y = padding.top + (height - padding.top - padding.bottom) * (1 - i / 5);
                    html += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" class="grid-line"/>`;
                    html += `<text x="${padding.left - 10}" y="${y + 4}" class="axis-label" text-anchor="end">${Math.round(maxVal * i / 5).toLocaleString()}</text>`;
                }
            }

            // X labels
            data.forEach((d, i) => {
                const x = padding.left + i * pointSpacing;
                html += `<text x="${x}" y="${height - padding.bottom + 25}" class="axis-label" text-anchor="middle">${d[labelKey]}</text>`;
            });

            // Areas (reverse order for layering)
            [...valueKeys].reverse().forEach((key, keyIdx) => {
                const color = chartColors[(valueKeys.length - 1 - keyIdx) % chartColors.length];
                let pathD = `M${padding.left},${baseY}`;

                data.forEach((d, i) => {
                    const x = padding.left + i * pointSpacing;
                    const y = baseY - (d[key] / maxVal) * (height - padding.top - padding.bottom);
                    pathD += `L${x},${y}`;
                });

                pathD += `L${padding.left + (data.length - 1) * pointSpacing},${baseY}Z`;

                html += `<path class="data-area" d="${pathD}" fill="${color}" opacity="0"
                    style="--target-opacity: 0.4"/>`;
            });

            // Lines on top
            valueKeys.forEach((key, keyIdx) => {
                const color = chartColors[keyIdx % chartColors.length];
                let lineD = '';

                data.forEach((d, i) => {
                    const x = padding.left + i * pointSpacing;
                    const y = baseY - (d[key] / maxVal) * (height - padding.top - padding.bottom);
                    lineD += (i === 0 ? 'M' : 'L') + `${x},${y}`;
                });

                const pathLength = data.length * 200;
                html += `<path class="data-line" d="${lineD}" stroke="${color}"
                    stroke-dasharray="${pathLength}" stroke-dashoffset="${pathLength}"/>`;
            });

            html += '</svg>';
            svg.outerHTML = html;

            renderLegend(valueKeys, chartColors);
        }

        function renderPieChart() {
            const svg = document.getElementById('chart');
            const rect = svg.getBoundingClientRect();
            const width = rect.width || 800;
            const height = rect.height || 500;

            const { headers, data } = chartData;
            const labelKey = headers[0];
            const valueKey = headers.find(h => typeof data[0][h] === 'number');
            const chartColors = getChartColors();

            const total = data.reduce((sum, d) => sum + d[valueKey], 0);
            const cx = width / 2;
            const cy = height / 2;
            const radius = Math.min(width, height) / 2 - 60;

            let html = `<svg viewBox="0 0 ${width} ${height}" class="chart-svg">`;

            let startAngle = -Math.PI / 2;

            data.forEach((d, i) => {
                const value = d[valueKey];
                const angle = (value / total) * Math.PI * 2;
                const endAngle = startAngle + angle;

                const x1 = cx + radius * Math.cos(startAngle);
                const y1 = cy + radius * Math.sin(startAngle);
                const x2 = cx + radius * Math.cos(endAngle);
                const y2 = cy + radius * Math.sin(endAngle);

                const largeArc = angle > Math.PI ? 1 : 0;

                const pathD = `M${cx},${cy} L${x1},${y1} A${radius},${radius} 0 ${largeArc},1 ${x2},${y2} Z`;

                html += `<path class="pie-slice" d="${pathD}" fill="${chartColors[i % chartColors.length]}"
                    data-label="${d[labelKey]}" data-value="${value}" data-percent="${((value/total)*100).toFixed(1)}"
                    transform="scale(0)" style="transform-origin: ${cx}px ${cy}px; --target-scale: 1"/>`;

                // Label
                const midAngle = startAngle + angle / 2;
                const labelRadius = radius * 0.7;
                const lx = cx + labelRadius * Math.cos(midAngle);
                const ly = cy + labelRadius * Math.sin(midAngle);

                html += `<text class="pie-label" x="${lx}" y="${ly}" fill="#fff" font-size="12" font-weight="600"
                    text-anchor="middle" dominant-baseline="middle" opacity="0">${((value/total)*100).toFixed(0)}%</text>`;

                startAngle = endAngle;
            });

            html += '</svg>';
            svg.outerHTML = html;

            renderLegend(data.map(d => d[labelKey]), chartColors);
            setupTooltips();
        }

        function renderLegend(labels, colors) {
            const legend = document.getElementById('legend');
            legend.style.display = 'flex';
            legend.innerHTML = labels.map((label, i) => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${colors[i % colors.length]}"></div>
                    <span>${label}</span>
                </div>
            `).join('');
        }

        function setupTooltips() {
            const tooltip = document.getElementById('tooltip');
            const container = document.getElementById('chartContainer');

            document.querySelectorAll('.data-bar, .data-point, .pie-slice').forEach(el => {
                el.addEventListener('mouseenter', e => {
                    const label = el.dataset.label;
                    const key = el.dataset.key || '';
                    const value = el.dataset.value;
                    const percent = el.dataset.percent;

                    tooltip.innerHTML = `
                        <div class="tooltip-label">${label}${key ? ' - ' + key : ''}</div>
                        <div class="tooltip-value">${parseFloat(value).toLocaleString()}${percent ? ` (${percent}%)` : ''}</div>
                    `;
                    tooltip.classList.add('visible');
                });

                el.addEventListener('mousemove', e => {
                    const rect = container.getBoundingClientRect();
                    tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
                    tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
                });

                el.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('visible');
                });
            });
        }

        // Animation
        function playAnimation() {
            isPlaying = true;
            document.getElementById('playIcon').innerHTML = '&#10074;&#10074;';
            animStartTime = performance.now() - (animationProgress * animDuration);
            animate();
        }

        function stopAnimation() {
            isPlaying = false;
            document.getElementById('playIcon').innerHTML = '&#9658;';
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
        }

        function toggleAnimation() {
            if (isPlaying) {
                stopAnimation();
            } else {
                if (animationProgress >= 1) {
                    animationProgress = 0;
                }
                playAnimation();
            }
        }

        function animate() {
            if (!isPlaying) return;

            const elapsed = (performance.now() - animStartTime) * speed;
            animationProgress = Math.min(1, elapsed / animDuration);

            updateAnimationProgress(animationProgress);
            document.getElementById('timelineProgress').style.width = (animationProgress * 100) + '%';

            if (animationProgress < 1) {
                animationFrame = requestAnimationFrame(animate);
            } else {
                stopAnimation();
            }
        }

        function updateAnimationProgress(progress) {
            const eased = easeOutCubic(progress);

            // Bars
            document.querySelectorAll('.data-bar').forEach(bar => {
                const targetY = parseFloat(bar.style.getPropertyValue('--target-y'));
                const targetHeight = parseFloat(bar.style.getPropertyValue('--target-height'));
                const baseY = parseFloat(bar.getAttribute('y')) || (500 - 60);

                bar.setAttribute('height', targetHeight * eased);
                bar.setAttribute('y', baseY - targetHeight * eased + (parseFloat(bar.dataset.baseY) || 0));
            });

            // Bar values
            document.querySelectorAll('.bar-value').forEach(text => {
                text.setAttribute('opacity', progress > 0.5 ? (progress - 0.5) * 2 : 0);
            });

            // Lines
            document.querySelectorAll('.data-line').forEach(line => {
                const length = parseFloat(line.style.getPropertyValue('--path-length')) || line.getTotalLength();
                line.style.strokeDashoffset = length * (1 - eased);
            });

            // Points
            document.querySelectorAll('.data-point').forEach((point, i) => {
                const delay = i * 0.1;
                const pointProgress = Math.max(0, Math.min(1, (progress - delay) / (1 - delay)));
                point.setAttribute('r', 6 * easeOutBack(pointProgress));
            });

            // Point values
            document.querySelectorAll('.point-value').forEach((text, i) => {
                const delay = i * 0.1 + 0.3;
                text.setAttribute('opacity', Math.max(0, Math.min(1, (progress - delay) * 3)));
            });

            // Areas
            document.querySelectorAll('.data-area').forEach((area, i) => {
                const delay = i * 0.1;
                const areaProgress = Math.max(0, Math.min(1, (progress - delay) / 0.5));
                area.setAttribute('opacity', 0.4 * eased);
            });

            // Pie slices
            document.querySelectorAll('.pie-slice').forEach((slice, i) => {
                const delay = i * 0.08;
                const sliceProgress = Math.max(0, Math.min(1, (progress - delay) / 0.4));
                slice.style.transform = `scale(${easeOutBack(sliceProgress)})`;
            });

            // Pie labels
            document.querySelectorAll('.pie-label').forEach((label, i) => {
                const delay = i * 0.08 + 0.3;
                label.setAttribute('opacity', Math.max(0, Math.min(1, (progress - delay) * 4)));
            });
        }

        function easeOutCubic(t) {
            return 1 - Math.pow(1 - t, 3);
        }

        function easeOutBack(t) {
            const c1 = 1.70158;
            const c3 = c1 + 1;
            return 1 + c3 * Math.pow(t - 1, 3) + c1 * Math.pow(t - 1, 2);
        }

        function seekAnimation(e) {
            const rect = e.target.getBoundingClientRect();
            const progress = (e.clientX - rect.left) / rect.width;
            animationProgress = Math.max(0, Math.min(1, progress));
            updateAnimationProgress(animationProgress);
            document.getElementById('timelineProgress').style.width = (animationProgress * 100) + '%';

            if (isPlaying) {
                animStartTime = performance.now() - (animationProgress * animDuration);
            }
        }

        function setSpeed() {
            speed = parseFloat(document.getElementById('speedSelect').value);
            if (isPlaying) {
                animStartTime = performance.now() - (animationProgress * animDuration / speed);
            }
        }

        function updateAnimSpeed() {
            animDuration = parseInt(document.getElementById('animSpeed').value);
        }

        // Export functions
        function exportSVG() {
            const svg = document.getElementById('chart');
            const svgData = new XMLSerializer().serializeToString(svg);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            downloadBlob(blob, 'chart.svg');
        }

        function exportPNG() {
            const svg = document.getElementById('chart');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const rect = svg.getBoundingClientRect();

            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);

            const svgData = new XMLSerializer().serializeToString(svg);
            const img = new Image();

            img.onload = () => {
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, rect.width, rect.height);
                ctx.drawImage(img, 0, 0, rect.width, rect.height);

                canvas.toBlob(blob => {
                    downloadBlob(blob, 'chart.png');
                });
            };

            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
